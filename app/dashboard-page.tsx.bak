// app/dashboard/page.tsx
'use client'

import { useAuth } from '@/lib/auth-context'
import { useRouter, useSearchParams } from 'next/navigation'
import { useCallback, useEffect, useMemo, useState, useTransition } from 'react'
import { supabase } from '@/lib/supabase'
import { AppNav } from '@/components/nav/AppNav'
import {
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, Legend,
} from 'recharts'
import { X } from 'lucide-react'
import {
  dismissMonthEndBanner,
  getMonthEndBannerState,
  runPnlCompletenessCheck,
  type CompletenessCheckResult,
} from '@/app/(dashboard)/_actions/monthEnd'

type DashboardStats = {
  batchesInProcess: number
  batchesCompleted: number
  lowStockCount: number
  pendingCOAs: number
}

type CompletedBatch = { id: string; completed_at: string | null }
type Ingredient = { id: string; name?: string | null; on_hand: number; reorder_point: number }
type COA = { batch_id: string }

type DayPoint = { day: string; completed: number }
type MixPoint = { label: string; count: number }

function toISODate(d: Date) {
  return d.toISOString().slice(0, 10)
}
function startOfDay(d: Date) {
  const x = new Date(d)
  x.setHours(0, 0, 0, 0)
  return x
}
function endOfDay(d: Date) {
  const x = new Date(d)
  x.setHours(23, 59, 59, 999)
  return x
}
function buildEmptySeries(fromISO: string, toISO: string): DayPoint[] {
  const from = startOfDay(new Date(fromISO))
  const to = endOfDay(new Date(toISO))
  const days: DayPoint[] = []
  for (let dt = new Date(from); dt <= to; dt.setDate(dt.getDate() + 1)) {
    days.push({ day: toISODate(dt), completed: 0 })
  }
  return days
}
function groupCompletedPerDay(emptySeries: DayPoint[], completed: CompletedBatch[]): DayPoint[] {
  const map = new Map(emptySeries.map((p) => [p.day, 0]))
  for (const b of completed) {
    if (!b.completed_at) continue
    const d = toISODate(new Date(b.completed_at))
    if (map.has(d)) map.set(d, (map.get(d) ?? 0) + 1)
  }
  return emptySeries.map((p) => ({ ...p, completed: map.get(p.day) ?? 0 }))
}
function exportCSV(filename: string, rows: Array<Record<string, unknown>>) {
  if (!rows.length) return
  const headers = Object.keys(rows[0]!)
  const csv = [headers.join(',')]
    .concat(
      rows.map((r) =>
        headers
          .map((h) => {
            const val = r[h]
            const s = val == null ? '' : String(val).replaceAll('"', '""')
            return `"${s}"`
          })
          .join(','),
      ),
    )
    .join('\n')
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = filename
  a.click()
  URL.revokeObjectURL(url)
}

export default function Dashboard() {
  const { user, profile, loading } = useAuth()
  const router = useRouter()
  const searchParams = useSearchParams()

  const today = useMemo(() => new Date(), [])
  const monthStart = useMemo(() => {
    const d = new Date()
    d.setDate(1)
    d.setHours(0, 0, 0, 0)
    return d
  }, [])
  const currentMonthParam = useMemo(() => {
    const month = today.getMonth() + 1
    return `${today.getFullYear()}-${String(month).padStart(2, '0')}`
  }, [today])

  const [from, setFrom] = useState<string>(toISODate(monthStart))
  const [to, setTo] = useState<string>(toISODate(today))

  const [stats, setStats] = useState<DashboardStats>({
    batchesInProcess: 0,
    batchesCompleted: 0,
    lowStockCount: 0,
    pendingCOAs: 0,
  })
  const [series, setSeries] = useState<DayPoint[]>([])
  const [mixData, setMixData] = useState<MixPoint[]>([])
  const [lowStockItems, setLowStockItems] = useState<Ingredient[]>([])
  const [pendingCOABatches, setPendingCOABatches] = useState<string[]>([])
  const [loadingStats, setLoadingStats] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [bannerState, setBannerState] = useState<{ show: boolean; daysLeft: number }>({
    show: false,
    daysLeft: 0,
  })
  const [checkModalOpen, setCheckModalOpen] = useState(false)
  const [checkResult, setCheckResult] = useState<CompletenessCheckResult | null>(null)
  const [checkError, setCheckError] = useState<string | null>(null)
  const [bannerPending, startBannerTransition] = useTransition()
  const [checkPending, startCheckTransition] = useTransition()

  useEffect(() => {
    if (!loading && !user) router.push('/login')
  }, [user, loading, router])

  const fetchDashboard = useCallback(async () => {
    if (!user) return
    setLoadingStats(true)
    setError(null)
    try {
      const fromTs = startOfDay(new Date(from)).toISOString()
      const toTs = endOfDay(new Date(to)).toISOString()

      // Parallel queries to minimize latency
      const [
        inProcRes,
        completedRangeRes,
        ingredientsRes,
        completedAllRes,
        coasRes,
      ] = await Promise.all([
        supabase.from('batches').select('*', { count: 'exact', head: true }).eq('status', 'in_process'),
        supabase
          .from('batches')
          .select('id, completed_at')
          .eq('status', 'completed')
          .gte('completed_at', fromTs)
          .lte('completed_at', toTs),
        supabase.from('ingredients').select('id,name,on_hand,reorder_point').eq('status', 'active'),
        supabase.from('batches').select('id').eq('status', 'completed'),
        supabase.from('coas').select('batch_id'),
      ])

      if (inProcRes.error) throw inProcRes.error
      if (completedRangeRes.error) throw completedRangeRes.error
      if (ingredientsRes.error) throw ingredientsRes.error
      if (completedAllRes.error) throw completedAllRes.error
      if (coasRes.error) throw coasRes.error

      const inProcessCount = inProcRes.count ?? 0
      const completedInRange = (completedRangeRes.data as CompletedBatch[]) ?? []
      const completedCount = completedInRange.length

      const ingredients = (ingredientsRes.data as Ingredient[]) ?? []
      const lowStock = ingredients.filter((i) => i.on_hand < i.reorder_point)

      const allCompleted = (completedAllRes.data as { id: string }[]) ?? []
      const coas = (coasRes.data as COA[]) ?? []
      const coasSet = new Set(coas.map((c) => c.batch_id))
      const pendingCOA = allCompleted.filter((b) => !coasSet.has(b.id)).map((b) => b.id)

      // Series and mix chart
      const blank = buildEmptySeries(from, to)
      const byDay = groupCompletedPerDay(blank, completedInRange)
      const mix: MixPoint[] = [
        { label: 'In-Process', count: inProcessCount },
        { label: 'Completed', count: completedCount },
      ]

      setSeries(byDay)
      setMixData(mix)
      setLowStockItems(lowStock)
      setPendingCOABatches(pendingCOA)
      setStats({
        batchesInProcess: inProcessCount,
        batchesCompleted: completedCount,
        lowStockCount: lowStock.length,
        pendingCOAs: pendingCOA.length,
      })
    } catch (e: any) {
      console.error('Error fetching dashboard:', e)
      setError(e?.message ?? 'Failed to load dashboard')
    } finally {
      setLoadingStats(false)
    }
  }, [user, from, to])

  const handleOpenPnl = useCallback(() => {
    router.push(`/pnl?month=${currentMonthParam}`)
  }, [router, currentMonthParam])

  const handleDismissBanner = useCallback(() => {
    startBannerTransition(async () => {
      await dismissMonthEndBanner({ untilMidnight: true })
      setBannerState((prev) => ({ ...prev, show: false }))
    })
  }, [startBannerTransition])

  const handleRunCompleteness = useCallback((monthOverride?: string) => {
    setCheckError(null)
    startCheckTransition(async () => {
      try {
        const result = await runPnlCompletenessCheck({
          month: monthOverride ?? currentMonthParam,
        })
        setCheckResult(result)
        setCheckModalOpen(true)
      } catch (err) {
        console.error('Completeness check failed:', err)
        setCheckError('Unable to run completeness check. Please try again.')
      }
    })
  }, [currentMonthParam, startCheckTransition])

  const handleCloseCompleteness = useCallback(() => {
    setCheckModalOpen(false)
  }, [])

  useEffect(() => {
    if (user) fetchDashboard()
  }, [user, fetchDashboard])

  useEffect(() => {
    if (!user) return
    startBannerTransition(async () => {
      const state = await getMonthEndBannerState({ now: new Date().toISOString() })
      setBannerState(state)
    })
  }, [user])

  useEffect(() => {
    if (!user) return
    const monthParam = searchParams?.get('monthEndChecklist')
    if (!monthParam) return
    handleRunCompleteness(monthParam)
    const nextParams = new URLSearchParams(searchParams.toString())
    nextParams.delete('monthEndChecklist')
    const queryString = nextParams.toString()
    router.replace(queryString ? `/?${queryString}` : '/', { scroll: false })
  }, [user, searchParams, handleRunCompleteness, router])

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-gray-600">Loading...</div>
      </div>
    )
  }
  if (!user || !profile) return null

  return (
    <div className="min-h-screen bg-gray-50">
      <AppNav currentPage="dashboard" />
      <main className="max-w-7xl mx-auto px-4 py-8">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-3xl font-bold text-gray-900">Dashboard</h1>
          <div className="flex gap-2">
            <div className="flex items-center gap-2">
              <label className="text-sm text-gray-600" htmlFor="from">From</label>
              <input
                id="from"
                type="date"
                value={from}
                onChange={(e) => setFrom(e.target.value)}
                className="rounded-md border border-gray-300 bg-white px-2 py-1 text-sm"
              />
            </div>
            <div className="flex items-center gap-2">
              <label className="text-sm text-gray-600" htmlFor="to">To</label>
              <input
                id="to"
                type="date"
                value={to}
                onChange={(e) => setTo(e.target.value)}
                className="rounded-md border border-gray-300 bg-white px-2 py-1 text-sm"
              />
            </div>
            <button
              onClick={fetchDashboard}
              className="rounded-md bg-[#174940] px-3 py-1.5 text-sm font-semibold text-white hover:opacity-90"
            >
              Refresh
            </button>
          </div>
        </div>

        {error && (
          <div className="mb-6 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700">
            {error}
          </div>
        )}

        {bannerState.show && (
          <div className="mb-6 rounded-lg border border-amber-200 bg-amber-50 p-4">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <div>
                <p className="text-base font-semibold text-amber-900">
                  Month end is in {bannerState.daysLeft} day{bannerState.daysLeft === 1 ? '' : 's'}.
                </p>
                <p className="text-sm text-amber-900">
                  Review P&amp;L inputs: Marketing, R&amp;D, Equipment; confirm batch postings &amp; inventory issues.
                </p>
              </div>
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={handleOpenPnl}
                  className="rounded-md bg-[#174940] px-4 py-2 text-sm font-semibold text-white hover:opacity-90"
                >
                  Open P&amp;L
                </button>
                <button
                  onClick={handleRunCompleteness}
                  disabled={checkPending}
                  className="rounded-md border border-[#174940] px-4 py-2 text-sm font-semibold text-[#174940] hover:bg-[#174940]/5 disabled:cursor-not-allowed disabled:border-gray-300 disabled:text-gray-400"
                >
                  {checkPending ? 'Checking‚Ä¶' : 'Run P&L Completeness Check'}
                </button>
                <button
                  onClick={handleDismissBanner}
                  disabled={bannerPending}
                  className="rounded-md border border-transparent px-4 py-2 text-sm font-medium text-[#174940] hover:bg-[#174940]/5 disabled:text-gray-400"
                >
                  {bannerPending ? 'Dismissing‚Ä¶' : 'Dismiss for today'}
                </button>
              </div>
            </div>
            {checkError && (
              <p className="mt-3 text-sm text-red-700">{checkError}</p>
            )}
          </div>
        )}

        {loadingStats ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {Array.from({ length: 4 }).map((_, i) => (
              <div key={i} className="h-28 rounded-lg bg-white shadow animate-pulse" />
            ))}
          </div>
        ) : (
          <>
            {/* KPIs */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div className="bg-white rounded-lg shadow p-6">
                <div className="text-sm text-gray-600 mb-2">Batches In-Process</div>
                <div className="text-3xl font-bold text-gray-900">{stats.batchesInProcess}</div>
                {stats.batchesInProcess > 0 && (
                  <button
                    onClick={() => router.push('/batches')}
                    className="mt-2 text-sm text-[#174940] hover:underline"
                  >
                    View batches ‚Üí
                  </button>
                )}
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <div className="text-sm text-gray-600 mb-2">Completed ({from} ‚Üí {to})</div>
                <div className="text-3xl font-bold text-gray-900">{stats.batchesCompleted}</div>
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <div className="text-sm text-gray-600 mb-2">Low-Stock Ingredients</div>
                <div className="text-3xl font-bold text-gray-900">{stats.lowStockCount}</div>
                {stats.lowStockCount > 0 && (
                  <button
                    onClick={() => router.push('/inventory')}
                    className="mt-2 text-sm text-amber-600 hover:underline"
                  >
                    ‚ö†Ô∏è Check inventory ‚Üí
                  </button>
                )}
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <div className="text-sm text-gray-600 mb-2">Pending COAs</div>
                <div className="text-3xl font-bold text-gray-900">{stats.pendingCOAs}</div>
                {stats.pendingCOAs > 0 && (
                  <button
                    onClick={() => router.push('/packaging')}
                    className="mt-2 text-sm text-amber-600 hover:underline"
                  >
                    ‚ö†Ô∏è Upload COAs ‚Üí
                  </button>
                )}
              </div>
            </div>

            {/* Charts */}
            <div className="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="bg-white rounded-lg shadow p-6 lg:col-span-2">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-semibold text-gray-900">Completed per Day</h2>
                </div>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={series} margin={{ left: 8, right: 8, top: 8, bottom: 8 }}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="day" minTickGap={24} />
                      <YAxis allowDecimals={false} />
                      <Tooltip />
                      <Legend />
                      <Line type="monotone" dataKey="completed" strokeWidth={2} dot={false} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-semibold text-gray-900">WIP vs Completed</h2>
                </div>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={mixData} margin={{ left: 8, right: 8, top: 8, bottom: 8 }}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="label" />
                      <YAxis allowDecimals={false} />
                      <Tooltip />
                      <Bar dataKey="count" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>

            {/* Low stock + Pending COAs */}
            <div className="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-semibold text-gray-900">Low-Stock Ingredients</h2>
                  {lowStockItems.length > 0 && (
                    <button
                      onClick={() =>
                        exportCSV(
                          'low_stock.csv',
                          lowStockItems.map((i) => ({
                            id: i.id,
                            name: i.name ?? '',
                            on_hand: i.on_hand,
                            reorder_point: i.reorder_point,
                          })),
                        )
                      }
                      className="text-sm rounded-md border border-gray-300 px-2 py-1 hover:bg-gray-50"
                    >
                      Export CSV
                    </button>
                  )}
                </div>
                {lowStockItems.length === 0 ? (
                  <div className="text-sm text-gray-600">All good‚Äîno items below reorder point.</div>
                ) : (
                  <div className="overflow-auto">
                    <table className="min-w-full text-sm">
                      <thead>
                        <tr className="text-left border-b">
                          <th className="py-2 pr-4">Name</th>
                          <th className="py-2 pr-4">On Hand</th>
                          <th className="py-2 pr-4">Reorder Point</th>
                        </tr>
                      </thead>
                      <tbody>
                        {lowStockItems.map((i) => (
                          <tr key={i.id} className="border-b last:border-b-0">
                            <td className="py-2 pr-4">{i.name ?? i.id}</td>
                            <td className="py-2 pr-4">{i.on_hand}</td>
                            <td className="py-2 pr-4">{i.reorder_point}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-semibold text-gray-900">Pending COAs</h2>
                  {pendingCOABatches.length > 0 && (
                    <button
                      onClick={() =>
                        exportCSV(
                          'pending_coas.csv',
                          pendingCOABatches.map((id) => ({ batch_id: id })),
                        )
                      }
                      className="text-sm rounded-md border border-gray-300 px-2 py-1 hover:bg-gray-50"
                    >
                      Export CSV
                    </button>
                  )}
                </div>
                {pendingCOABatches.length === 0 ? (
                  <div className="text-sm text-gray-600">No pending COAs üéâ</div>
                ) : (
                  <div className="overflow-auto">
                    <table className="min-w-full text-sm">
                      <thead>
                        <tr className="text-left border-b">
                          <th className="py-2 pr-4">Batch ID</th>
                          <th className="py-2 pr-4">Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {pendingCOABatches.map((id) => (
                          <tr key={id} className="border-b last:border-b-0">
                            <td className="py-2 pr-4">{id}</td>
                            <td className="py-2 pr-4">
                              <button
                    onClick={() => router.push(`/packaging?batch=${encodeURIComponent(id)}`)}
                                className="text-sm text-[#174940] hover:underline"
                              >
                                Upload COA ‚Üí
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </div>

            {/* Welcome card (kept) */}
            <div className="mt-8 bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-semibold text-gray-900 mb-4">Welcome to CureCore ERP!</h2>
              <p className="text-gray-600 mb-4">
                You&apos;re logged in as <strong>{profile.email}</strong> with role <strong>{profile.role}</strong>.
              </p>

              {(stats.lowStockCount > 0 || stats.pendingCOAs > 0) && (
                <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded">
                  <h3 className="font-semibold text-amber-900 mb-2">Action Required:</h3>
                  <ul className="space-y-1 text-sm text-amber-800">
                    {stats.lowStockCount > 0 && <li>‚Ä¢ {stats.lowStockCount} ingredient(s) below reorder point</li>}
                    {stats.pendingCOAs > 0 && <li>‚Ä¢ {stats.pendingCOAs} completed batch(es) need COA upload</li>}
                  </ul>
                </div>
              )}

              <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <button
                  onClick={() => router.push('/batches')}
                  className="p-4 border border-gray-200 rounded hover:border-[#174940] hover:bg-gray-50 text-left"
                >
                  <div className="font-semibold text-gray-900">Create New Batch</div>
                  <div className="text-sm text-gray-600 mt-1">Start a new production batch</div>
                </button>
                <button
                  onClick={() => router.push('/formulations')}
                  className="p-4 border border-gray-200 rounded hover:border-[#174940] hover:bg-gray-50 text-left"
                >
                  <div className="font-semibold text-gray-900">New Formulation</div>
                  <div className="text-sm text-gray-600 mt-1">Create a new product formula</div>
                </button>
                <button
                  onClick={() => router.push('/inventory')}
                  className="p-4 border border-gray-200 rounded hover:border-[#174940] hover:bg-gray-50 text-left"
                >
                  <div className="font-semibold text-gray-900">Manage Inventory</div>
                  <div className="text-sm text-gray-600 mt-1">View and adjust stock levels</div>
                </button>
              </div>
            </div>
          </>
        )}
      </main>
      {checkModalOpen && checkResult && (
        <CompletenessModal result={checkResult} onClose={handleCloseCompleteness} />
      )}
    </div>
  )
}

function CompletenessModal({
  result,
  onClose,
}: {
  result: CompletenessCheckResult
  onClose: () => void
}) {
  const hasItems = result.items.length > 0
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 py-8">
      <div className="w-full max-w-3xl rounded-lg bg-white shadow-xl">
        <div className="flex items-center justify-between border-b border-gray-200 px-4 py-3">
          <h2 className="text-lg font-semibold text-gray-900">P&amp;L Completeness Check</h2>
          <button
            onClick={onClose}
            className="rounded-full p-1 text-gray-500 hover:bg-gray-100 hover:text-gray-700"
            aria-label="Close completeness results"
          >
            <X className="h-5 w-5" />
          </button>
        </div>
        <div className="px-4 py-5 space-y-4">
          <div className="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
              <p className="text-sm text-gray-500">Month</p>
              <p className="text-base font-semibold text-gray-900">{result.month}</p>
            </div>
            <div className="flex gap-4 text-sm">
              <span className="rounded bg-green-100 px-2 py-1 text-green-800">
                Passed: {result.summary.passed}
              </span>
              <span className="rounded bg-red-100 px-2 py-1 text-red-800">
                Outstanding: {result.summary.failed}
              </span>
            </div>
          </div>

          {hasItems ? (
            <div className="space-y-3">
              {result.items.map((item) => (
                <div
                  key={item.key}
                  className="rounded border border-gray-200 p-3"
                >
                  <div className="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                      <p className="font-medium text-gray-900">{item.label}</p>
                      <p className={`text-sm ${item.passed ? 'text-green-700' : 'text-red-700'}`}>
                        {item.passed ? 'Complete' : 'Action required'}
                      </p>
                      {item.details && (
                        <p className="mt-1 text-sm text-gray-600">{item.details}</p>
                      )}
                    </div>
                    <div className="flex flex-col items-start gap-2 md:items-end">
                      {typeof item.passedCount === 'number' && typeof item.totalCount === 'number' && (
                        <span className="text-xs text-gray-500">
                          {item.passedCount}/{item.totalCount} complete
                        </span>
                      )}
                      {item.link && (
                        <a
                          href={item.link}
                          className="text-sm font-medium text-[#174940] hover:underline"
                        >
                          Go to area ‚Üí
                        </a>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="rounded border border-gray-200 bg-gray-50 p-4 text-sm text-gray-600">
              No checklist items found for this month.
            </div>
          )}

          {result.fixList.length > 0 && (
            <div className="rounded border border-amber-200 bg-amber-50 p-4">
              <p className="text-sm font-semibold text-amber-900">Fix list</p>
              <ul className="mt-2 space-y-1 text-sm text-amber-900">
                {result.fixList.map((fix) => (
                  <li key={fix.key}>
                    ‚Ä¢ {fix.label}
                    {fix.link && (
                      <>
                        {' '}
                        <a href={fix.link} className="font-medium text-[#174940] hover:underline">
                          Open
                        </a>
                      </>
                    )}
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
        <div className="flex justify-end border-t border-gray-200 px-4 py-3">
          <button
            onClick={onClose}
            className="rounded-md bg-[#174940] px-4 py-2 text-sm font-semibold text-white hover:opacity-90"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  )
}
